# .ebextensions/01_install_chrome.config
# Este archivo de configuración instala Google Chrome para que Marp CLI pueda generar PDFs.

commands:
  01_install_chrome_for_marp:
    # Este comando instala Chrome for Testing y sus dependencias.
    # Es idempotente y seguro de ejecutar en cada despliegue.
    # 1. Instala las dependencias de Chrome usando el gestor de paquetes dnf.
    # 2. Usa npx para descargar e instalar la versión estable de Chrome for Testing.
    # 3. Crea un enlace simbólico al ejecutable de chrome en /usr/local/bin.
    command: |
      echo "Instalando dependencias de Chrome..."
      dnf deplist https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm \
      | grep provider \
      | sort --unique \
      | awk '{print $2}' \
      | xargs dnf install -y --allowerasing --skip-broken --quiet

      echo "Instalando Chrome for Testing usando npx @puppeteer/browsers..."
      CHROME_PATH=$(npx --yes @puppeteer/browsers install chrome@stable | awk '{print $2}')

      echo "Creando enlace simbólico para Chrome..."
      if [ -f "$CHROME_PATH" ]; then
        ln -sf "$CHROME_PATH" /usr/local/bin/chrome
        echo "Enlace simbólico para Chrome creado en /usr/local/bin/chrome."
      else
        echo "Error: No se pudo encontrar la ruta del ejecutable de Chrome."
        exit 1
      fi
    cwd: /tmp
    # Los comandos en .ebextensions se ejecutan como root, por lo que no se necesita 'sudo'.
    # ignoreErrors: false asegura que si este script falla, el despliegue se detendrá.
    ignoreErrors: false
